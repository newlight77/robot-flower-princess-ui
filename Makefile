#!make

# Robot Flower Princess - Makefile

SHELL := /bin/sh

.PHONY: help install clean test build run docker-build docker-run

help: ## Show this help message
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $1, $2}'

install: ## Install dependencies
	flutter pub get
	flutter pub run build_runner build --delete-conflicting-outputs

clean: ## Clean build artifacts
	flutter clean
	rm -rf build/
	rm -rf .dart_tool/

test: ## Run all tests
	flutter test

test-unit: ## Run unit tests only (individual functions and classes)
	@echo "üß™ Running UNIT tests..."
	@flutter test test/unit/ --coverage --coverage-path coverage/unit-coverage/lcov.info
	@echo "‚úÖ Unit tests complete!"
	@echo "üìä Total Coverage: $$(lcov --summary coverage/unit-coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')%"

test-use-case: ## Run use case tests only (business logic and rules)
	@echo "üß™ Running USE CASE tests..."
	@flutter test test/use_case/ --coverage --coverage-path coverage/use-case-coverage/lcov.info
	@echo "‚úÖ Use case tests complete!"
	@echo "üìä Total Coverage: $$(lcov --summary coverage/use-case-coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')%"

test-widget: ## Run widget tests only (UI component tests)
	@echo "üß™ Running WIDGET tests..."
	@flutter test test/widget/ --coverage --coverage-path coverage/widget-coverage/lcov.info
	@echo "‚úÖ Widget tests complete!"
	@echo "üìä Total Coverage: $$(lcov --summary coverage/widget-coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')%"

test-feature: ## Run feature tests only (end-to-end with fake backend)
	@echo "üß™ Running FEATURE tests..."
	@flutter test test/feature/ --coverage --coverage-path coverage/feature-coverage/lcov.info
	@echo "‚úÖ Feature tests complete!"
	@echo "üìä Total Coverage: $$(lcov --summary coverage/feature-coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')%"

test-all: ## Run all tests
	@echo "üß™ Running ALL TEST SUITES..."
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "1Ô∏è‚É£  UNIT TESTS (Functions & Classes)"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@make test-unit
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "2Ô∏è‚É£  USE CASE TESTS (Business Logic)"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@make test-use-case
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "3Ô∏è‚É£  WIDGET TESTS (UI Components)"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@make test-widget
	@echo ""
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@echo "4Ô∏è‚É£  FEATURE TESTS (End-to-End)"
	@echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
	@make test-feature
	@echo ""
	@echo "‚úÖ ALL TESTS COMPLETE!"

coverage:
	@make coverage-combine
	@make coverage-threshold
	@make coverage-detail
	@echo "‚úÖ Coverage Workflow Complete!"
	@echo ""

test-coverage: ## Run tests with coverage
	@make test-unit
	@make test-use-case
	@make test-widget
	@make test-feature
	@make coverage-combine
	@make coverage-threshold
	@make coverage-detail
	@echo "‚úÖ Coverage Workflow Complete!"
	@echo ""

coverage-combine:
	@echo "üéØ Merging coverage reports..."
	@lcov --add-tracefile coverage/unit-coverage/lcov.info \
	      --add-tracefile coverage/use-case-coverage/lcov.info \
	      --add-tracefile coverage/widget-coverage/lcov.info \
	      --add-tracefile coverage/feature-coverage/lcov.info \
	      --output-file coverage/lcov.info
	@echo "üîß Removing test helpers from coverage..."
	@lcov --remove coverage/lcov.info \
	      '*/game_mock_datasource.dart' \
	      '*/game_mock_repository.dart' \
	      --output-file coverage/lcov.info
	@echo "‚úÖ Coverage reports merged (excluding mock files)"
	@echo ""

coverage-html: test-all coverage-combine coverage-threshold ## Generate HTML coverage report
	@echo "üåê Generating HTML coverage report..."
	@genhtml coverage/lcov.info -o coverage/html 2>/dev/null || echo "‚ö†Ô∏è  genhtml not installed. Install with: brew install lcov"
	@echo "‚úÖ HTML report generated at coverage/html/index.html"

coverage-threshold:
	@echo "üéØ Checking coverage threshold (80%)..."
	@COVERAGE=$$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $$2}' | sed 's/%//'); \
	THRESHOLD=80; \
	if [ $$(echo "$$COVERAGE < $$THRESHOLD" | bc) -eq 1 ]; then \
		echo "‚ùå Coverage $$COVERAGE% is below threshold $$THRESHOLD%"; \
		exit 1; \
	else \
		echo "‚úÖ Coverage $$COVERAGE% meets threshold $$THRESHOLD%"; \
	fi

coverage-detail: ## Show detailed coverage by file
	@echo "üìä DETAILED COVERAGE BY FILE"
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@lcov --list coverage/lcov.info 2>/dev/null || echo "‚ö†Ô∏è  lcov not installed. Install with: brew install lcov"


coverage-clean: ## Clean coverage artifacts
	@echo "üßπ Cleaning CI artifacts..."
	@rm -rf coverage-artifacts
	@rm -rf coverage
	@echo "‚úÖ Clean complete"

format: ## Format code
	dart format lib/ test/

analyze: ## Analyze code
	flutter analyze

build-web: ## Build for web
	flutter build web --release

build-android: ## Build for Android
	flutter build apk --release

build-ios: ## Build for iOS
	flutter build ios --release

run-web: ## Run on web
	flutter run -d chrome

run-mobile: ## Run on mobile device
	flutter run

docker-build: ## Build Docker image
	docker build -t robot-flower-princess-ui:latest .

docker-run: ## Run Docker container
	docker run -p 8080:80 robot-flower-princess-ui:latest

docker-stop: ## Stop Docker container
	docker stop $(docker ps -q --filter ancestor=robot-flower-princess:latest)

setup: ## Complete setup (install + generate code)
	@echo "üöÄ Setting up Robot Flower Princess..."
	flutter pub get
	flutter pub run build_runner build --delete-conflicting-outputs
	@echo "‚úÖ Setup complete!"

dev: ## Run in development mode
	flutter run -d chrome --hot

run: ## Run in production mode
	flutter run -d chrome

ci: ## Run CI checks
	flutter pub get
	flutter analyze
	flutter test --coverage
	flutter build web --release
